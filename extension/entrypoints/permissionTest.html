<!DOCTYPE html>
<html>
<head>
  <title>Microphone Permission Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
    }
    h1 {
      color: #2563eb;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background-color: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }
    .error {
      background-color: #fee2e2;
      border: 1px solid #ef4444;
      color: #b91c1c;
    }
    .info {
      background-color: #e0f2fe;
      border: 1px solid #0ea5e9;
      color: #0369a1;
    }
    .recording-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }
    .recording-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ef4444;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }
    pre {
      background-color: #f1f5f9;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    audio {
      width: 100%;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Microphone Permission Test</h1>
  <p>This page tests microphone permissions for the Chrome extension.</p>
  
  <button id="checkPermission">Check Microphone Permission</button>
  <button id="requestPermission">Request Microphone Permission</button>
  <button id="startRecording" disabled>Start Recording</button>
  <button id="stopRecording" disabled>Stop Recording</button>
  
  <div id="permissionStatus" class="status info">Microphone permission status: unknown</div>
  
  <div id="recordingStatus" style="display: none;">
    <div class="recording-indicator">
      <div class="recording-dot"></div>
      <span>Recording...</span>
    </div>
    <p>Duration: <span id="duration">0s</span></p>
  </div>
  
  <div id="recordingResult" style="display: none;">
    <h2>Recording Result</h2>
    <audio id="audioPlayer" controls></audio>
    <div>
      <p>Audio details:</p>
      <pre id="audioDetails"></pre>
    </div>
  </div>
  
  <script>
    let mediaRecorder;
    let audioChunks = [];
    let timerInterval;
    let durationSeconds = 0;
    
    const permissionStatusEl = document.getElementById('permissionStatus');
    const recordingStatusEl = document.getElementById('recordingStatus');
    const recordingResultEl = document.getElementById('recordingResult');
    const durationEl = document.getElementById('duration');
    const audioPlayerEl = document.getElementById('audioPlayer');
    const audioDetailsEl = document.getElementById('audioDetails');
    const startRecordingBtn = document.getElementById('startRecording');
    const stopRecordingBtn = document.getElementById('stopRecording');
    
    // Check permission button
    document.getElementById('checkPermission').addEventListener('click', async () => {
      try {
        permissionStatusEl.className = 'status info';
        permissionStatusEl.textContent = 'Checking microphone permission...';
        
        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
        
        if (permissionStatus.state === 'granted') {
          permissionStatusEl.className = 'status success';
          permissionStatusEl.textContent = `Microphone permission: GRANTED`;
          startRecordingBtn.disabled = false;
        } else if (permissionStatus.state === 'denied') {
          permissionStatusEl.className = 'status error';
          permissionStatusEl.textContent = `Microphone permission: DENIED - Please enable in Chrome settings`;
          startRecordingBtn.disabled = true;
        } else {
          permissionStatusEl.className = 'status info';
          permissionStatusEl.textContent = `Microphone permission: ${permissionStatus.state.toUpperCase()} - Please click "Request Microphone Permission"`;
          startRecordingBtn.disabled = true;
        }
        
        // Log all devices
        const devices = await navigator.mediaDevices.enumerateDevices();
        console.log('All devices:', devices);
        
        // Log audio input devices
        const audioInputDevices = devices.filter(device => device.kind === 'audioinput');
        console.log('Audio input devices:', audioInputDevices);
        
        // Add device info to details
        let deviceInfo = `Permission state: ${permissionStatus.state}\n\n`;
        deviceInfo += `Audio input devices (${audioInputDevices.length}):\n`;
        audioInputDevices.forEach((device, index) => {
          deviceInfo += `${index + 1}. ${device.label || 'Unnamed device'} (${device.deviceId.substring(0, 8)}...)\n`;
        });
        
        audioDetailsEl.textContent = deviceInfo;
        recordingResultEl.style.display = 'block';
      } catch (error) {
        permissionStatusEl.className = 'status error';
        permissionStatusEl.textContent = `Error checking permission: ${error.message}`;
        console.error('Error checking permission:', error);
      }
    });
    
    // Request permission button
    document.getElementById('requestPermission').addEventListener('click', async () => {
      try {
        permissionStatusEl.className = 'status info';
        permissionStatusEl.textContent = 'Requesting microphone permission...';
        
        // This will trigger the permission prompt
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        permissionStatusEl.className = 'status success';
        permissionStatusEl.textContent = 'Microphone permission granted successfully!';
        startRecordingBtn.disabled = false;
        
        // Stop the stream - we're just checking permissions
        stream.getTracks().forEach(track => track.stop());
      } catch (error) {
        permissionStatusEl.className = 'status error';
        permissionStatusEl.textContent = `Error requesting permission: ${error.message}`;
        console.error('Error requesting permission:', error);
      }
    });
    
    // Start recording button
    document.getElementById('startRecording').addEventListener('click', async () => {
      try {
        // Reset previous recording
        audioChunks = [];
        durationSeconds = 0;
        durationEl.textContent = '0s';
        
        // Get audio stream
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Create media recorder
        mediaRecorder = new MediaRecorder(stream);
        
        // Set up event handlers
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = () => {
          // Create audio blob
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          
          // Set audio player source
          audioPlayerEl.src = audioUrl;
          
          // Update audio details
          audioDetailsEl.textContent = `Recording details:
- Type: ${audioBlob.type}
- Size: ${(audioBlob.size / 1024).toFixed(2)} KB
- Duration: ${durationSeconds}s`;
          
          // Show recording result
          recordingResultEl.style.display = 'block';
          recordingStatusEl.style.display = 'none';
          
          // Enable/disable buttons
          startRecordingBtn.disabled = false;
          stopRecordingBtn.disabled = true;
          
          // Stop all tracks to release microphone
          stream.getTracks().forEach(track => track.stop());
        };
        
        // Start recording
        mediaRecorder.start(1000); // Capture chunks every second
        
        // Update UI
        recordingStatusEl.style.display = 'block';
        startRecordingBtn.disabled = true;
        stopRecordingBtn.disabled = false;
        
        // Start duration timer
        timerInterval = setInterval(() => {
          durationSeconds++;
          durationEl.textContent = `${durationSeconds}s`;
        }, 1000);
        
      } catch (error) {
        permissionStatusEl.className = 'status error';
        permissionStatusEl.textContent = `Error starting recording: ${error.message}`;
        console.error('Error starting recording:', error);
      }
    });
    
    // Stop recording button
    document.getElementById('stopRecording').addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(timerInterval);
      }
    });
    
    // Initial permission check
    navigator.permissions.query({ name: 'microphone' })
      .then(permissionStatus => {
        if (permissionStatus.state === 'granted') {
          permissionStatusEl.className = 'status success';
          permissionStatusEl.textContent = `Microphone permission: GRANTED`;
          startRecordingBtn.disabled = false;
        } else if (permissionStatus.state === 'denied') {
          permissionStatusEl.className = 'status error';
          permissionStatusEl.textContent = `Microphone permission: DENIED - Please enable in Chrome settings`;
        } else {
          permissionStatusEl.className = 'status info';
          permissionStatusEl.textContent = `Microphone permission: ${permissionStatus.state.toUpperCase()} - Please click "Request Microphone Permission"`;
        }
      })
      .catch(error => {
        permissionStatusEl.className = 'status error';
        permissionStatusEl.textContent = `Error checking permission: ${error.message}`;
        console.error('Error checking permission:', error);
      });
  </script>
</body>
</html> 