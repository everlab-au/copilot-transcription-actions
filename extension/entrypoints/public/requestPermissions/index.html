<!DOCTYPE html>
<html>
<head>
  <title>Microphone Permission Request</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
    }
    h1 {
      color: #2563eb;
      margin-bottom: 20px;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
      display: block;
      width: 100%;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background-color: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }
    .error {
      background-color: #fee2e2;
      border: 1px solid #ef4444;
      color: #b91c1c;
    }
    .info {
      background-color: #e0f2fe;
      border: 1px solid #0ea5e9;
      color: #0369a1;
    }
  </style>
</head>
<body>
  <h1>Microphone Permission Request</h1>
  <p>This extension needs microphone access to transcribe audio during meetings.</p>
  
  <div id="permissionStatus" class="status info">Checking microphone permission...</div>
  
  <button id="requestPermission">Request Microphone Permission</button>
  
  <script>
    const permissionStatusEl = document.getElementById('permissionStatus');
    const requestPermissionBtn = document.getElementById('requestPermission');
    
    // Function to notify background script about permission status
    function notifyBackgroundScript(granted, error = null) {
      if (granted) {
        chrome.runtime.sendMessage({
          action: "permissionGranted",
          type: "microphone"
        });
      } else {
        chrome.runtime.sendMessage({
          action: "permissionDenied",
          type: "microphone",
          error: error || "Permission denied"
        });
      }
    }
    
    // Function to close this tab or offscreen document
    function closeWindowOrTab() {
      // If this is loaded in an offscreen document, the document will be closed by background script
      // If this is loaded in a regular tab, try to close it
      setTimeout(() => {
        window.close();
      }, 1000);
    }
    
    // Function to request microphone permission
    function requestMicrophonePermission() {
      permissionStatusEl.className = 'status info';
      permissionStatusEl.textContent = 'Requesting microphone permission...';
      
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          // Permission granted
          permissionStatusEl.className = 'status success';
          permissionStatusEl.textContent = 'Microphone access granted successfully! This window will close automatically.';
          
          // Stop all tracks immediately
          stream.getTracks().forEach(track => track.stop());
          
          // Notify the background script
          notifyBackgroundScript(true);
          
          // Close window after short delay
          closeWindowOrTab();
        })
        .catch(error => {
          // Permission denied or error
          permissionStatusEl.className = 'status error';
          
          if (error.name === "NotAllowedError") {
            permissionStatusEl.textContent = `Microphone access denied - Please enable in browser settings`;
          } else {
            permissionStatusEl.textContent = `Error: ${error.message}`;
          }
          
          // Notify the background script
          notifyBackgroundScript(false, error.message || "Permission denied");
          
          // Don't auto-close on error so user can read message
        });
    }
    
    // Add click event to button
    requestPermissionBtn.addEventListener('click', requestMicrophonePermission);
    
    // Check permission on page load
    async function checkInitialPermission() {
      try {
        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
        
        if (permissionStatus.state === 'granted') {
          permissionStatusEl.className = 'status success';
          permissionStatusEl.textContent = 'Microphone permission: GRANTED';
          
          // Double-check with getUserMedia
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => track.stop());
            
            // Notify background script that permission is already granted
            notifyBackgroundScript(true);
            
            // Close window after short delay
            closeWindowOrTab();
          } catch (mediaError) {
            // If getUserMedia fails despite permission API saying granted
            requestMicrophonePermission();
          }
        } else if (permissionStatus.state === 'denied') {
          permissionStatusEl.className = 'status error';
          permissionStatusEl.textContent = 'Microphone permission: DENIED - Please enable in browser settings';
          
          // Notify background script
          notifyBackgroundScript(false, "Permission already denied in browser settings");
        } else {
          // Explicitly request permission right away
          requestMicrophonePermission();
        }
      } catch (error) {
        console.error('Error checking permission:', error);
        // Fall back to direct request
        requestMicrophonePermission();
      }
    }
    
    // Run initial check when page loads
    window.addEventListener('DOMContentLoaded', checkInitialPermission);
  </script>
</body>
</html> 